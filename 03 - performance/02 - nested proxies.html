<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<title>Nested Proxies</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<style type="text/css">
			body {
				margin: 0 auto;
				max-width: 40em;
				width: 88%;
			}
		</style>
	</head>

	<body>

		<h1>Nested Proxies</h1>

		<div id="app"></div>


		<script>
			let Rue = (function () {

				/**
				 * Debounce rendering for better performance
				 * @param  {Constructor} instance The current instantiation
				 */
				function debounceRender (instance) {

					// If there's a pending render, cancel it
					if (instance._debounce) {
						window.cancelAnimationFrame(instance._debounce);
					}

					// Setup the new render to run at the next animation frame
					instance._debounce = window.requestAnimationFrame(function () {
						instance.render();
					});

				}

				/**
				 * Create handler methods for the proxy
				 * @param  {Constructor} instance The constructor instance
				 * @return {Object}               The handler methods
				 */
				function handler (instance) {
					return {
						get: function (obj, prop) {

							// If the item is an object or array, return a proxy
							if (['[object Object]', '[object Array]'].includes(Object.prototype.toString.call(obj[prop]))) {
								return new Proxy(obj[prop], handler(instance));
							}

							// Otherwise, return the property
							return obj[prop];

						},
						set: function (obj, prop, value) {

							// Update the property
							obj[prop] = value;

							// Render the UI
							debounceRender(instance);

							// Indicate success
							// This is required
							return true;

						},
						deleteProperty: function (obj, prop) {

							// Delete the property
							delete obj[prop];

							// Render the UI
							debounceRender(instance);

							// Indicate success
							// This is required
							return true;

						}
					};
				}

				/**
				 * The Constructor object
				 * @param {String} selector The selector for the element to render into
				 * @param {Object} options  The component options
				 */
				function Constructor (selector, options) {
					this.elem = document.querySelector(selector);
					this.data = new Proxy(options.data, handler(this));
					this.template = options.template;
					this._debounce = null;
				}

				/**
				 * Render the UI
				 */
				Constructor.prototype.render = function () {
					console.log('rendered');
					this.elem.innerHTML = this.template(this.data);
				};

				return Constructor;

			})();

			// Create a wizards and witches component
			let app = new Rue('#app', {
				data: {
					wizards: {
						list: ['Gandalf', 'Radagast', 'Merlin']
					},
					witches: {
						list: ['Ursula', 'Wicked Witch Of The West', 'Malificent']
					}
				},
				template: function (props) {

					// If there are no wizards, show a message
					if (!props.wizards.list.length || !props.witches.list.length) {
						return `There aren't any wizards or witches yet.`;
					}

					// Otherwise, show a list
					return `
						<h2>Wizards</h2>
						<ul>
							${props.wizards.list.map(function (wizard) {
								return `<li>${wizard}</li>`;
							}).join('')}
						</ul>

						<h2>Witches</h2>
						<ul>
							${props.witches.list.map(function (witch) {
								return `<li>${witch}</li>`;
							}).join('')}
						</ul>`;

				}
			});

			// Render the UI
			app.render();

			/**
			 * Reverse the witches and wizards
			 */
			function swapMagic () {
				let tempCache = app.data.wizards.list;
				app.data.wizards.list = app.data.witches.list;
				app.data.witches.list = tempCache;
				console.log(app.data.wizards.list, app.data.witches.list);
			}
		</script>
	</body>
</html>